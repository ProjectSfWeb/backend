# Описание проекта

Этот код представляет собой бэкенд-сервис, построенный на базе фреймворка FastAPI.  Сервис использует PostgreSQL в качестве базы данных и предоставляет API для работы с балансом, фильтрами, транзакциями, аутентификацией и экспортом транзакций в Excel.

**Репозиторий проекта:** [https://github.com/ProjectSfWeb/backend](https://github.com/ProjectSfWeb/backend)

## Обзор

Код состоит из следующих основных частей:

1.  **Инициализация FastAPI и подключение роутеров:**

    *   Создается экземпляр FastAPI `app = FastAPI()`.
    *   Подключаются роутеры из различных модулей: `balance`, `filters`, `transactions`, `auth`, `transaction_excel`.  Каждый из этих модулей содержит определение API-эндпоинтов, связанных с соответствующей функциональностью.
    *   Определен простой GET-эндпоинт по адресу `/`, который возвращает сообщение "FastAPI is running".
    *   В блоке `if __name__ == "__main__":` запускается Uvicorn (ASGI-сервер) для обслуживания приложения FastAPI. Uvicorn использует хост `127.0.0.1` (localhost), порт `8000` и включает автоматическую перезагрузку при изменении кода (`reload=True`).

2.  **Настройка базы данных PostgreSQL:**

    *   Используется библиотека `dotenv` для загрузки переменных окружения из файла `.env`.
    *   Считываются параметры подключения к базе данных (пользователь, пароль, хост, порт, имя базы данных) из переменных окружения.  Это позволяет избежать жесткой прошивки учетных данных в коде и упрощает конфигурацию в разных окружениях.
    *   Формируется строка подключения к базе данных (DATABASE_URL) на основе полученных параметров.
    *   Создается SQLAlchemy engine, который устанавливает соединение с базой данных.
    *   Создается `SessionLocal` – фабрика для создания сессий базы данных.  Каждая сессия представляет собой транзакцию с базой данных.
    *   Определяется функция `get_db`, которая предоставляет сессию базы данных для каждого запроса.  Эта функция использует менеджер контекста (`try...finally`), чтобы гарантировать закрытие сессии после завершения запроса, даже если произошла ошибка.
    *   `models.Base.metadata.create_all(bind=engine)` создает таблицы базы данных, если они еще не существуют.  Модели данных SQLAlchemy определены в модуле `models`.  База данных развернута онлайн на PostgreSQL.

3.  **Модели данных (SQLAlchemy):**

    В этом проекте используются следующие модели данных SQLAlchemy:

    *   **User:**
        *   `id` (Integer, primary key, index): Уникальный идентификатор пользователя.
        *   `username` (String, index): Имя пользователя.
        *   `password_hash` (String): Хэш пароля пользователя.
        *   `email` (String): Email пользователя.
        *   `categories` (Relationship): Связь "один ко многим" с моделью `Category`. Пользователь может иметь несколько категорий.
        *   `transactions` (Relationship): Связь "один ко многим" с моделью `Transaction`. Пользователь может иметь несколько транзакций.

    *   **Category:**
        *   `id` (Integer, primary key, index): Уникальный идентификатор категории.
        *   `name` (String): Название категории.
        *   `user_id` (Integer, ForeignKey("user.id")): Внешний ключ, связывающий категорию с пользователем.
        *   `user` (Relationship): Связь "многие к одному" с моделью `User`.
        *   `transactions` (Relationship): Связь "один ко многим" с моделью `Transaction`. Категория может иметь несколько транзакций.

    *   **Transaction:**
        *   `id` (BigInteger, primary key, index): Уникальный идентификатор транзакции.
        *   `user_id` (Integer, ForeignKey("user.id")): Внешний ключ, связывающий транзакцию с пользователем.
        *   `transTypeID` (BigInteger, ForeignKey("trans_type.id")): Внешний ключ, связывающий транзакцию с типом транзакции.
        *   `status_id` (BigInteger, ForeignKey("trans_status.id")): Внешний ключ, связывающий транзакцию со статусом транзакции.
        *   `category_id` (BigInteger, ForeignKey("category.id")): Внешний ключ, связывающий транзакцию с категорией.
        *   `person_typeID` (Integer, ForeignKey("person_type.id")): Внешний ключ, связывающий транзакцию с типом персоны.
        *   `timestamp` (DateTime, default=datetime.datetime.utcnow): Временная метка транзакции.
        *   `amount` (BigInteger): Сумма транзакции.
        *   `comment` (String): Комментарий к транзакции.
        *   `sender_bank` (String): Банк отправителя.
        *   `receiver_bank` (String): Банк получателя.
        *   `account` (String): Номер счета.
        *   `rec_inn` (String): ИНН получателя.
        *   `rec_acc` (String): Номер счета получателя.
        *   `rec_phone` (String): Телефон получателя.
        *   `user` (Relationship): Связь "многие к одному" с моделью `User`.
        *   `trans_type` (Relationship): Связь "многие к одному" с моделью `TransType`.
        *   `trans_status` (Relationship): Связь "многие к одному" с моделью `TransStatus`.
        *   `category` (Relationship): Связь "многие к одному" с моделью `Category`.
        *   `person_type` (Relationship): Связь "многие к одному" с моделью `PersonType`.

    *   **TransType:**
        *   `id` (BigInteger, primary key, index): Уникальный идентификатор типа транзакции.
        *   `name` (String): Название типа транзакции.
        *   `transactions` (Relationship): Связь "один ко многим" с моделью `Transaction`.

    *   **TransStatus:**
        *   `id` (BigInteger, primary key, index): Уникальный идентификатор статуса транзакции.
        *   `name` (String): Название статуса транзакции.
        *   `transactions` (Relationship): Связь "один ко многим" с моделью `Transaction`.

    *   **PersonType:**
        *   `id` (Integer, primary_key=True, index=True): Уникальный идентификатор типа персоны.
        *   `name` (String): Название типа персоны.
        *   `transactions` (Relationship): Связь "один ко многим" с моделью `Transaction`.

4.  **API Endpoints (Роутеры):**

    *   **`balance`**:
        *   Содержит роут для расчета баланса доходов и расходов пользователя. Требует аутентификации.

    *   **`filters`**:
        *   Содержит роут для применения фильтров к транзакциям.
        *   Возвращает данные для дашбордов и транзакции, соответствующие фильтрам, на основе query-параметров.

    *   **`transactions`**:
        *   Содержит роуты для:
            *   Добавления новой транзакции.  Валидирует ИНН и номер телефона.  Автоматически создает новую категорию, если пользователь ранее её не вносил. Требует аутентификации.
            *   Обновления существующей транзакции (только транзакции со статусом "Новая"). Требует аутентификации.
            *   Удаления транзакции. Требует аутентификации.

    *   **`auth`**:
        *   Содержит роуты для регистрации и аутентификации пользователей:
            *   `/register`:  Регистрирует нового пользователя, хеширует пароль и сохраняет данные в БД.
            *   `/login`: Авторизует пользователя, проверяет логин/пароль и устанавливает токен в Cookie.

    *   **`transaction_excel`**:
        *   Содержит роут для выгрузки транзакций текущего пользователя в Excel-файл. Требует аутентификации.

## Зависимости

*   `fastapi`: Web framework.
*   `uvicorn`: ASGI server.
*   `sqlalchemy`: ORM для работы с базами данных.
*   `python-dotenv`: Для загрузки переменных окружения из `.env` файла.
*   `psycopg2` (или `asyncpg`): Драйвер для подключения к PostgreSQL.  (Не указан явно в коде, но подразумевается для SQLAlchemy + PostgreSQL).

## Переменные окружения

Для корректной работы приложения необходимо определить следующие переменные окружения:

*   `DATABASE_USER`: Имя пользователя базы данных.
*   `DATABASE_PASSWORD`: Пароль пользователя базы данных.
*   `DATABASE_HOST`: Хост базы данных.
*   `DATABASE_PORT`: Порт базы данных.
*   `DATABASE_NAME`: Имя базы данных.

Эти переменные обычно определяются в файле `.env` в корне проекта.


## Запуск приложения

1.  Убедитесь, что у вас установлен Python 3.7+ и pip.
2.  Клонируйте репозиторий: `git clone https://github.com/ProjectSfWeb/backend`
3.  Перейдите в директорию проекта: `cd backend`
4.  Создайте виртуальное окружение: `python -m venv venv`
5.  Активируйте виртуальное окружение:
    *   Linux/macOS: `source venv/bin/activate`
    *   Windows: `venv\Scripts\activate`
6.  **Установите зависимости из файла `requirements.txt`:** `pip install -r requirements.txt`
7.  Создайте файл `.env` в корне проекта и добавьте переменные окружения.
8.  Запустите приложение: `python main.py` (запускается из `main.py`)


## Тестирование
1. Проведено ручное тестирование логики регистрации и авторизации. При регистрации пароль хешируется корректно. Доступ к данным пользователя возможен только после ввода корректных логина и пароля пользователя.
2. Проведено ручное тестирование фильтров по транзакциям. Сервер возвращает только транзакции, соответствующие введнным фильтрам. Есть возможность отображения всех транзакций пользователя. Отображаются только транзакции авторизованного пользователя.
3. Проведено ручное тестирование доступна транзакций для выгрузки в excel.


## Frontend: 
При запуске приложения можно перейти по следующим адресам для просмотра фронтенда приложения:
/front/comingin - форма входа
/front/register2 - форма регистрации
/front/balance/ - основная страница приложения
/front/change - изменение транзакции
/front/delete - удаление транзакции. 
Также на данных страницах работают кнопки: "Регистрация", " Выйти", "Назад", "Change transaction", "Delete transaction ", и выпадающие списки фильтров
   

## Дополнительная информация

*   БД развернута онлайн на PostgreSQL.
*   Разработчики: Владимир Иванов, Анна Чернорубашкина, Павел Залыгин, Андрей Сергеев, Никита Мишин
*   Тимлид: Никита Мишин
